<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>PDF Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <main class="container">
        <h1>PDF Editor</h1>

        <!-- Drag-and-Drop Uploader -->
        <div id="drop-zone" class="drop-zone">
            <p>Drop your PDF here or click to browse</p>
            <div id="progress-bar" class="progress-bar hidden">
                <div class="progress-fill"></div>
            </div>
            <input type="file" id="pdf-upload" accept="application/pdf">
            <button id="browse-btn" title="Browse Files">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            </button>
        </div>

        <!-- Buttons -->
        <div class="button-group">
            <button id="theme-toggle" title="Toggle Dark Mode">
                <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            <button id="clear-btn" title="Clear PDF">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    <line x1="10" x2="10" y1="11" y2="17"></line>
                    <line x1="14" x2="14" y1="11" y2="17"></line>
                </svg>
            </button>
            <button id="download-btn" class="hidden" title="Save and Download">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
        </div>

        <!-- Zoom Control -->
        <div id="zoom-control" class="zoom-control hidden">
            <button id="zoom-icon" title="Zoom">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                </svg>
            </button>
            <input type="range" id="zoom-slider" min="100" max="200" value="100">
        </div>

        <!-- Debug State -->
        <div id="state-debug"></div>

        <!-- Page Grid -->
        <div id="page-grid" class="page-grid"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        let pageOrder = [];
        let pagesToDelete = [];
        let originalFile = null;
        let previews = [];
        let zoomLevel = 100;
        let sortable = null;

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.innerHTML = theme === 'dark' ?
                `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>` :
                `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
        };
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            setTheme(currentTheme);
            console.log(`Switched to ${currentTheme} mode`);
        });

        // Drag-and-Drop Uploader
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('pdf-upload');
        const browseBtn = document.getElementById('browse-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.querySelector('.progress-fill');
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomControl = document.getElementById('zoom-control');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                fileInput.files = e.dataTransfer.files;
                handleUpload(file);
            }
        });

        browseBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleUpload(file);
        });

        async function handleUpload(file) {
            originalFile = file;
            progressBar.classList.remove('hidden');
            progressFill.classList.add('active');
            const formData = new FormData();
            formData.append('pdf', file);
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.error) {
                    console.error(data.error);
                    alert('Error uploading PDF: ' + data.error);
                    return;
                }
                previews = data.previews;
                pageOrder = data.pageOrder;
                pagesToDelete = data.pagesToDelete;
                console.log(`Upload successful: ${previews.length} previews received`);
                renderPages();
                updateDebugState();
                document.getElementById('download-btn').classList.remove('hidden');
                zoomControl.classList.remove('hidden'); // Show zoom control
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading PDF: ' + error.message);
            } finally {
                progressBar.classList.add('hidden');
                progressFill.classList.remove('active');
            }
        }

        function updateDebugState() {
            document.getElementById('state-debug').innerHTML = `
                <p>Current state - Page Order: ${JSON.stringify(pageOrder)}, Pages to Delete: ${JSON.stringify(pagesToDelete)}</p>
            `;
        }

        document.getElementById('clear-btn').addEventListener('click', async () => {
            await fetch('/clear', { method: 'POST' });
            pageOrder = [];
            pagesToDelete = [];
            previews = [];
            originalFile = null;
            zoomLevel = 100;
            zoomSlider.value = 100;
            document.getElementById('page-grid').innerHTML = '';
            document.getElementById('state-debug').innerHTML = '';
            document.getElementById('download-btn').classList.add('hidden');
            zoomControl.classList.add('hidden'); // Hide zoom control
            document.getElementById('pdf-upload').value = '';
            console.log('Cleared state');
        });

        document.getElementById('download-btn').addEventListener('click', async () => {
            console.log('Before download:', { pageOrder, pagesToDelete });
            try {
                const response = await fetch('/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pageOrder, pagesToDelete })
                });
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Download error:', error);
                    alert('Error generating PDF: ' + error.error);
                    return;
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'modified.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('Download initiated');
            } catch (error) {
                console.error('Download fetch error:', error);
                alert('Error generating PDF: ' + error.message);
            }
        });

        zoomSlider.addEventListener('input', () => {
            zoomLevel = parseInt(zoomSlider.value);
            renderPages();
        });

        function renderPages() {
            const grid = document.getElementById('page-grid');
            const pageHeight = (350 * zoomLevel / 100) + 16; // Adjust height with zoom
            const maxPagesPerColumn = Math.floor(window.innerHeight / pageHeight);
            const visiblePages = pageOrder.filter(idx => !pagesToDelete.includes(idx)).length;
            const columns = Math.max(1, Math.ceil(visiblePages / maxPagesPerColumn));
            grid.style.gridTemplateColumns = `repeat(${columns}, ${250 * zoomLevel / 100}px)`; // Adjust column width
            grid.style.setProperty('--zoom', zoomLevel / 100); // Set CSS variable
            // Destroy previous Sortable instance cleanly
            if (sortable) {
                sortable.destroy();
                sortable = null;
            }
            grid.innerHTML = '';
            pageOrder.forEach((idx, i) => {
                if (!pagesToDelete.includes(idx)) {
                    console.log(`Rendering page ${idx + 1}, base64 length: ${previews[idx].length}`);
                    const div = document.createElement('div');
                    div.className = 'page-item';
                    div.dataset.index = idx;
                    div.setAttribute('draggable', 'true'); // helps on Android
                    div.innerHTML = `
                        <img src="data:image/png;base64,${previews[idx]}" alt="Page ${idx + 1}">
                        <span class="page-number">${idx + 1}</span>
                        <label class="delete-toggle">
                            <input type="checkbox" class="delete-checkbox" data-index="${idx}">
                            <span class="toggle-slider"></span>
                        </label>
                    `;
                    grid.appendChild(div);
                }
            });
            // Re-initialize Sortable cleanly
            sortable = new Sortable(grid, {
                animation: 150,
                swap: true,
                filter: '.delete-toggle, .delete-checkbox, .toggle-slider',
                preventOnFilter: false,
                onEnd: function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    if (oldIndex !== newIndex) {
                        const moved = pageOrder.splice(oldIndex, 1)[0];
                        pageOrder.splice(newIndex, 0, moved);
                        console.log('Updated pageOrder:', pageOrder);
                        renderPages(); // trigger re-render
                        updateDebugState();
                    }
                }
            });
            document.querySelectorAll('.delete-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    console.log(`Delete checkbox clicked: idx=${idx}`);
                    if (e.target.checked) {
                        const pageItem = checkbox.closest('.page-item');
                        pageItem.classList.add('deleting');
                        setTimeout(() => {
                            pagesToDelete.push(idx);
                            console.log(`Adding idx to pagesToDelete: ${idx}`);
                            console.log('pagesToDelete after update:', pagesToDelete);
                            renderPages();
                            updateDebugState();
                        }, 300);
                    } else {
                        pagesToDelete = pagesToDelete.filter(i => i !== idx);
                        console.log(`Removing idx from pagesToDelete: ${idx}`);
                        console.log('pagesToDelete after update:', pagesToDelete);
                        renderPages();
                        updateDebugState();
                    }
                });
            });
        }
    </script>
</body>
</html>